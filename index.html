<!DOCTYPE html>
<html lang="ja">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="https://cdn.glitch.com/96450832-6fe3-4117-ab8e-3ee9479c71dd%2Ffavicon.ico?1552076618478">
  <link rel="apple-touch-icon" href="https://cdn.glitch.com/96450832-6fe3-4117-ab8e-3ee9479c71dd%2FREVi.png?1552077340411" />
  <link rel="manifest" href="manifest.json">
  <script>
    window.addEventListener('load', function () {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("/service-worker.js");
      }
    });
  </script>
  <title>REVi</title>
  <link rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <h1>REVi</h1>
    <form class="form-group" id="form" style="text-align: center;">
      <div class="form-group">
        <label class="roomLabel" for="rooms"></label>
        <input type="tel" class="form-control" id="rooms" style="color: white; background-color: black; width: 100%" placeholder="Room ID" maxlength="5" autocomplete="off" required>
      </div>
      <button type="button" class="btn btn-primary" id="share" style="background-color: black; border-color: white; width: 32%;">Share</button>
      <button type="button" class="btn btn-primary" id="watch" style="background-color: black; border-color: white; width: 32%;">Watch</button>
      <button type="button" class="btn btn-primary" id="leave" style="background-color: black; border-color: white; width: 32%;">Leave</button>
    </form>
    <br>
    <div class="video-container" id="video-container">
      <p class="border"></p>
      <h2>Your screen</h2>
      <video id="local_video" autoplay muted>
        <p>
          にゃーん
        </p>
      </video>
      <br>
      <br>
      <p class="border"></p>
      <br>
      <div id="remote_videos"></div>
    </div>
  </div>

  <script src="//cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
  <!-- script -->
  <script type="text/javascript">
    const Peer = window.Peer;

    (async function main() {
      const localVideo = document.getElementById('local_video');
      const remoteVideos = document.getElementById('remote_videos');
      const shareTrigger = document.getElementById('share');
      const watchTrigger = document.getElementById('watch');
      const leaveTrigger = document.getElementById('leave');
      var mode = new Map();
      leaveTrigger.disabled = true;
      var is_shared = false;

      const peer = new Peer({
        key: "b2002378-5532-44a8-a1b5-712c137db594",
        debug: 2,
        sdpSemantics: "unified-plan"
      });

      var localStream = null;
      window.addEventListener("message", first_listen);
      function first_listen (event) {
        console.log("receive");
        if (event.data.direction == "streamId") {
          get_user_media(event.data.message, "local_video");
          window.removeEventListener("message", first_listen);
        }
      };

      set_event();

      // listen event
      function set_event() {
        watchTrigger.addEventListener('click', watch, { once: true });
        async function watch() {
          await shareTrigger.removeEventListener('click', share);
          console.log('watch');
          is_shared = false;
          const roomId = await $("#rooms").val();
          if (!peer.open) {
            return;
          }
          var room = await peer.joinRoom(roomId, {
            mode: 'mesh'
          });
          prepare4share(room, "watch");
        };

        shareTrigger.addEventListener('click', share, { once: true });
        async function share() {
          await watchTrigger.removeEventListener('click', watch);
          is_shared = true;
          const roomId = await $("#rooms").val();
          window.postMessage("share");
          if (!peer.open) {
            console.log('peer is not opened');
            return;
          }
          var set_interval_id = setInterval(wait, 1000);
          async function wait() {
            console.log("wait");
            if (localStream != null) {
              console.log("break");
              clearInterval(set_interval_id);
              var room = await peer.joinRoom(roomId, {
                mode: 'mesh',
                stream: localStream
              });
              prepare4share(room, "share");
            }
          }
        };
      }

      // capture
      function get_user_media(streamId, videoId) {
        navigator.mediaDevices.getUserMedia({
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: streamId
            }
          },
          audio: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: streamId
            }
          }
        }).then(stream => {
          localStream = stream;
          document.getElementById(videoId).srcObject = localStream;
          let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
          if (typeof deviceId === 'object') {
            deviceId = JSON.stringify(deviceId);
          }
          console.log(`stream.getConstraints().deviceId=${deviceId}`);
        }).catch(err => {
          console.error(err);
        });
      }

      // share
      async function prepare4share(room, join_mode) {
        leaveTrigger.disabled = false;

        room.on('peerJoin', peerId => {
          mode[peerId] = join_mode;
        });

        room.on('stream', async stream => {
          console.log('stream');
          if (stream == null)
            console.log("null stream");
          const newVideo = document.createElement('video');
          newVideo.controls = true;
          newVideo.srcObject = stream;
          newVideo.setAttribute('id', stream.peerId);
          remoteVideos.append(newVideo);
          await newVideo.play().catch(console.error);
        });

        room.on('peerLeave', peerId => {
          const remoteVideo = document.getElementById(peerId);
          if (remoteVideo != null) {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
            remoteVideo.remove();
          }
        });

        room.once('close', async () => {
          await Array.from(remoteVideos.children).forEach(remoteVideo => {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
            remoteVideo.remove();
          });
          if (localStream != null) {
            await localStream.getTracks().forEach(function (track) {
              track.stop();
            });
          }
          await window.removeEventListener("message", send_request);
          await shareTrigger.removeEventListener('click', change2share);
          await watchTrigger.removeEventListener('click', change2watch);
          leaveTrigger.disabled = true;
          set_event();
        });

        room.on('data', async ({ data, src }) => {
          if (mode[src] != null && mode[src] == "share") {
            const remoteVideo = document.getElementById(src);
            if (remoteVideo != null) {
              switch (data) {
                case "watch":
                  remoteVideo.setAttribute("display", "none");
                  localVideo.setAttribute("display", "none");
                  break;
                case "share":
                  remoteVideo.setAttribute("display", "block");
                  localVideo.setAttribute("display", "block");
                  break;
              }
            }
          }
          mode[src] = data;
        });

        window.addEventListener("message", send_request);
        async function send_request(event) {
          console.log("receive");
          if (event.data.direction == "streamId") {
            if (localStream != null) {
              await localStream.getTracks().forEach(function (track) {
                track.stop();
              });
              localStream = null;
            }
            await get_user_media(event.data.message, "local_video");
            var set_interval_id = setInterval(wait, 1000);
            function wait() {
              if (localStream != null) {
                clearInterval(set_interval_id);
                room.replaceStream(localStream);
                room.send('replace');
                console.log("replace");
              }
            }
          }
        };

        shareTrigger.addEventListener('click', change2share);
        function change2share() {
          window.postMessage("share");
          is_shared = true;
          room.send("share");
        };

        watchTrigger.addEventListener('click', change2watch);
        function change2watch() {
          is_shared = false;
          if (localStream != null) {
            localStream.getTracks().forEach(function (track) {
              track.stop();
            });
          }
          room.send("watch");
        };

        leaveTrigger.addEventListener('click', () => {
          room.close();
        }, { once: true });
      }

      peer.on('error', console.error);
    })();
  </script>
</body>
</html>
