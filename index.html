<!DOCTYPE html>
<html lang="ja">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="https://cdn.glitch.com/96450832-6fe3-4117-ab8e-3ee9479c71dd%2Ffavicon.ico?1552289454711">
  <link rel="apple-touch-icon" href="https://cdn.glitch.com/96450832-6fe3-4117-ab8e-3ee9479c71dd%2Frevi.png?1552289433650" />
  <link rel="manifest" href="manifest.json">
  <script>
    window.addEventListener('load', function () {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("/service-worker.js");
      }
    });
  </script>
  <title>REVi</title>
  <link rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <h1>REVi</h1>
    <form class="form-group" id="form" style="text-align: center;">
      <div class="form-group">
        <label class="roomLabel" for="rooms"></label>
        <input type="tel" class="form-control" id="rooms" style="color: white; background-color: black; width: 100%" placeholder="Room ID" maxlength="5" autocomplete="off" required>
      </div>
      <button type="button" class="btn btn-primary" id="screen" style="background-color: black; border-color: white; width: 24%;">Screen</button>
      <button type="button" class="btn btn-primary" id="camera" style="background-color: black; border-color: white; width: 24%;">Camera</button>
      <button type="button" class="btn btn-primary" id="watch" style="background-color: black; border-color: white; width: 24%;">Watch</button>
      <button type="button" class="btn btn-primary" id="leave" style="background-color: black; border-color: white; width: 24%;">Leave</button>
    </form>
    <br>
    <br>
    <div class="video-container" id="video-container">
      <div class="local">
        <video id="local_video" autoplay muted>
          <p>
            にゃーん
          </p>
        </video>
        <span id="local">Your screen </span>
      </div>
      <br>
      <br>
      <div id="remote_videos"></div>
    </div>
  </div>

  <script src="//cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
  <!-- script -->
  <script type="text/javascript">
    const Peer = window.Peer;

    (async function main() {
      const localVideo = document.getElementById('local_video');
      const local_sign = document.getElementById('local');
      const remoteVideos = document.getElementById('remote_videos');
      const screenTrigger = document.getElementById('screen');
      const cameraTrigger = document.getElementById('camera');
      const watchTrigger = document.getElementById('watch');
      const leaveTrigger = document.getElementById('leave');
      const roomId_form = document.getElementById('rooms');
      localVideo.hidden = true;
      local_sign.hidden = true;
      leaveTrigger.disabled = true;
      var is_shared = false;
      var socket = io.connect();
      var peer;

      function get_browser_info(userAgent) {
        if (userAgent.indexOf('opera') != -1) {
          return 'opera';
        } else if (userAgent.indexOf('msie') != -1) {
          return 'ie';
        } else if (userAgent.indexOf('chrome') != -1) {
          return 'chrome';
        } else if (userAgent.indexOf('safari') != -1) {
          return 'safari';
        } else if (userAgent.indexOf('gecko') != -1) {
          return 'gecko';
        } else {
          return false;
        }
      }
      const browser = await get_browser_info(window.navigator.userAgent.toLowerCase());
      console.log(browser);

      socket.emit('message', 'key_request');
      socket.on('api_key', function (data) {
        peer = new Peer({
          key: data.key,
          debug: 2,
          sdpSemantics: "unified-plan"
        });
      });

      var localStream = null;
      window.addEventListener("message", first_listen);
      function first_listen(event) {
        if (event.data.direction == "streamId") {
          console.log("receive");
          get_user_media(event.data.message, "local_video");
          window.removeEventListener("message", first_listen);
        }
      };

      set_event();

      // listen event
      function set_event() {
        watchTrigger.addEventListener('click', watch, { once: true });
        async function watch() {
          localVideo.hidden = true;
          local_sign.hidden = true;
          await screenTrigger.removeEventListener('click', screen);
          await cameraTrigger.removeEventListener('click', camera);
          console.log('watch');
          is_shared = false;
          const roomId = await $("#rooms").val() + 0;
          if (!peer.open) {
            return;
          }
          var room = await peer.joinRoom(roomId, {
            mode: 'mesh'
          });
          prepare4share(room);
        };

        screenTrigger.addEventListener('click', screen, { once: true });
        async function screen() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          await cameraTrigger.removeEventListener('click', camera);
          await watchTrigger.removeEventListener('click', watch);
          is_shared = true;
          const roomId = await $("#rooms").val() + 0;
          switch (browser) {
            case 'chrome':
              window.postMessage("share");
              break;
            default:
              get_user_media("", "local_video", "screen");
          }
          if (!peer.open) {
            console.log('peer is not opened');
            return;
          }
          var set_interval_id = setInterval(wait, 1000);
          async function wait() {
            console.log("wait");
            if (localStream != null) {
              console.log("break");
              clearInterval(set_interval_id);
              var room = await peer.joinRoom(roomId, {
                mode: 'mesh',
                stream: localStream
              });
              prepare4share(room);
            }
          }
        };

        cameraTrigger.addEventListener('click', camera, { once: true });
        async function camera() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          await screenTrigger.removeEventListener('click', screen);
          await watchTrigger.removeEventListener('click', watch);
          is_shared = true;
          const roomId = await $("#rooms").val() + 0;
          get_user_media("", "local_video", "camera");
          if (!peer.open) {
            console.log('peer is not opened');
            return;
          }
          var set_interval_id = setInterval(wait, 1000);
          async function wait() {
            console.log("wait");
            if (localStream != null) {
              console.log("break");
              clearInterval(set_interval_id);
              var room = await peer.joinRoom(roomId, {
                mode: 'mesh',
                stream: localStream
              });
              prepare4share(room);
            }
          }
        };
      }

      // capture
      function get_user_media(streamId, videoId, mode) {
        switch (mode) {
          case 'screen':
            switch (browser) {
              case 'chrome':
                navigator.mediaDevices.getUserMedia({
                  video: {
                    mandatory: {
                      chromeMediaSource: 'desktop',
                      chromeMediaSourceId: streamId
                    }
                  },
                  audio: {
                    mandatory: {
                      chromeMediaSource: 'desktop',
                      chromeMediaSourceId: streamId
                    }
                  }
                }).then(stream => {
                  localStream = stream;
                  document.getElementById(videoId).srcObject = localStream;
                  let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
                  if (typeof deviceId === 'object') {
                    deviceId = JSON.stringify(deviceId);
                  }
                  console.log(`stream.getConstraints().deviceId=${deviceId}`);
                }).catch(err => {
                  console.error(err);
                });
                break;
              default:
                const is_screen = window.confirm('あなたが共有したいのはスクリーン全体ですか?');
                navigator.mediaDevices.getUserMedia({
                  video: { mediaSource: is_screen ? 'screen' : 'window' },
                  audio: true
                }).then(stream => {
                  localStream = stream;
                  document.getElementById(videoId).srcObject = localStream;
                  let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
                  if (typeof deviceId === 'object') {
                    deviceId = JSON.stringify(deviceId);
                  }
                  console.log(`stream.getConstraints().deviceId=${deviceId}`);
                }).catch(err => {
                  console.error(err);
                });;
            }
            break;
          case 'camera':
            navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true
            }).then(stream => {
              localStream = stream;
              document.getElementById(videoId).srcObject = localStream;
              let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
              if (typeof deviceId === 'object') {
                deviceId = JSON.stringify(deviceId);
              }
              console.log(`stream.getConstraints().deviceId=${deviceId}`);
            }).catch(err => {
              console.error(err);
            });;
            break;
        }
      }

      // share
      async function prepare4share(room) {
        roomId_form.disabled = true;
        leaveTrigger.disabled = false;

        room.on('stream', async stream => {
          console.log('stream');
          if (stream == null)
            console.log("null stream");
          const newVideo = document.createElement('video');
          newVideo.controls = true;
          newVideo.srcObject = stream;
          newVideo.setAttribute('id', stream.peerId);
          remoteVideos.append(newVideo);
          await newVideo.play().catch(console.error);
        });

        room.on('peerLeave', peerId => {
          const remoteVideo = document.getElementById(peerId);
          if (remoteVideo != null) {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
            remoteVideo.remove();
          }
        });

        room.once('close', async () => {
          await Array.from(remoteVideos.children).forEach(remoteVideo => {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.srcObject = null;
            remoteVideo.remove();
            console.log("remove");
          });
          if (localStream != null) {
            await localStream.getTracks().forEach(function (track) {
              track.stop();
            });
          }
          await window.removeEventListener("message", send_request);
          await screenTrigger.removeEventListener('click', change2screen);
          await cameraTrigger.removeEventListener('click', change2camera);
          await watchTrigger.removeEventListener('click', change2watch);
          roomId_form.disabled = false;
          leaveTrigger.disabled = true;
          set_event();
        });

        room.on('data', async ({ data, src }) => {
          console.log(data);
          var remoteVideo = document.getElementById(src);
          switch (data) {
            case "watch":
              remoteVideo.hidden = true;
              break;
            case "share":
              remoteVideo.hidden = false;
              break;
          }
        });

        window.addEventListener("message", send_request);
        async function send_request(event) {
          console.log("receive");
          if (event.data.direction == "streamId") {
            if (localStream != null) {
              localStream.getTracks().forEach(function (track) {
                track.stop();
              });
              localStream = null;
            }
            await get_user_media(event.data.message, "local_video", "screen");
            var set_interval_id = setInterval(wait, 1000);
            function wait() {
              if (localStream != null) {
                clearInterval(set_interval_id);
                room.replaceStream(localStream);
                room.send('share');
                console.log("replace");
              }
            }
          }
        };

        screenTrigger.addEventListener('click', change2screen);
        function change2screen() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          switch (browser) {
            case 'chrome':
              window.postMessage("share");
              break;
            default:
              get_user_media("", "local_video", 'screen');
          }
          is_shared = true;
        };

        cameraTrigger.addEventListener('click', change2camera);
        function change2camera() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          get_user_media("", "local_video", 'camera');
          is_shared = true;
        };

        watchTrigger.addEventListener('click', change2watch);
        async function change2watch() {
          localVideo.hidden = true;
          local_sign.hidden = true;
          is_shared = false;
          if (localStream != null) {
            await localStream.getTracks().forEach(function (track) {
              track.stop();
            });
          }
          room.send("watch");
        };

        leaveTrigger.addEventListener('click', () => {
          localVideo.hidden = true;
          local_sign.hidden = true;
          room.close();
        }, { once: true });

        peer.on('error', console.error);
      }
    })();
  </script>
</body>
</html>
