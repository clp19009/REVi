<!DOCTYPE html>
<html lang="ja">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="image/revi.png">
  <link rel="apple-touch-icon" href="image/revi_manifest.png" />
  <link rel="manifest" href="manifest.json">
  <script>
    window.addEventListener('load', function () {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("/service-worker.js");
      }
    });
  </script>
  <title>REVi</title>
  <link rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
</head>

<body>
  <div style="width: 100%; height: 10%; min-height: 85px; position: fixed; z-index: 999; background-color: rgba(42, 42, 42, 0.8);">
    <input type="tel" class="form" id="rooms" style="top: 5px; bottom: 55%; left: 1%; width: 48.5%;" placeholder="Room ID" required>
    <input type="text" class="form" id="name" style="top: 5px; bottom: 55%; left: 50.5%; width: 48.5%;" placeholder="Name" required>
    <button type="button" class="btn fa fa-tv" id="screen" style="color: white; background-color: rgba(42, 42, 42, 0.0); text-align: center; font-size: 90%; position: absolute; bottom: 0px; left: 0%; width: 25%; height: 50%;"> 画面共有</button>
    <button type="button" class="btn fa fa-video" id="camera" style="color: white; background-color: rgba(42, 42, 42, 0.0); text-align: center; font-size: 90%; position: absolute; bottom: 0px; left: 25%; width: 25%; height: 50%;"> カメラ共有</button>
    <button type="button" class="btn fa fa-sign-in-alt" id="watch" style="color: white; background-color: rgba(42, 42, 42, 0.0); text-align: center; font-size: 90%; position: absolute; bottom: 0px; left: 50%; width: 25%; height: 50%;"> 参加</button>
    <button type="button" class="btn fa fa-sign-out-alt" id="leave" style="color: white; background-color: rgba(42, 42, 42, 0.0); text-align: center; font-size: 90%; position: absolute; bottom: 0px; left: 75%; width: 25%; height: 50%;"> 退出</button>
  </div>

  <div style="width: 100%; height: 10%; min-height: 85px; position: absolute;">
    <div class="container" style="position: absolute; top: 110%; right: 5px; left: 10%;">
      <div class="video-container" id="video-container">
        <div class="video_area">
          <video id="local_video" autoplay muted>
            <p>
              にゃーん
            </p>
          </video>
          <span id="local">Your screen </span>
        </div>
        <div id="remote_videos"></div>
      </div>
    </div>
    <div class="name_list" style="position: absolute; top: 110%; right: 90%; left: 5px;">
      <div id="name_list"></div>
    </div>
  </div>

  <!-- modal for select camera -->
  <div class="modal" id="camera_selector">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          Please select camera.
        </div>
        <div class="modal-body">
          <select id="cameras"></select>
          <select id="mics"></select>
        </div>
        <div class="modal-footer">
        </div>
      </div>
    </div>
  </div>

  <script src="//cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
  <!-- script -->
  <script type="text/javascript">
    const Peer = window.Peer;

    (async function main() {
      const localVideo = document.getElementById('local_video');
      const local_sign = document.getElementById('local');
      const remoteVideos = document.getElementById('remote_videos');
      const screenTrigger = document.getElementById('screen');
      const cameraTrigger = document.getElementById('camera');
      const watchTrigger = document.getElementById('watch');
      const leaveTrigger = document.getElementById('leave');
      const roomId_form = document.getElementById('rooms');
      const camera_selector = document.getElementById('camera_selector');
      const nameList = document.getElementById('name_list');
      camera_selector.style.display = 'none';
      localVideo.hidden = true;
      local_sign.hidden = true;
      leaveTrigger.disabled = true;
      var is_shared = false;
      var socket = io.connect();
      var peer;

      const browser = await get_browser(window.navigator.userAgent.toLowerCase());
      console.log(browser);

      socket.emit("key_request", {});
      socket.on('api_key', function (data) {
        peer = new Peer({
          key: data.key,
          debug: 2,
          sdpSemantics: "unified-plan"
        });
      });

      var localStream = null;
      window.addEventListener("message", first_listen);
      function first_listen(event) {
        if (event.data.direction == "streamId") {
          console.log("receive");
          get_user_media(event.data.message, "local_video", "screen");
          window.removeEventListener("message", first_listen);
        }
      };

      var set_interval_id4peer = setInterval(wait_peer, 500);
      async function wait_peer() {
        if (peer != null) {
          set_event();
          clearInterval(set_interval_id4peer);
        }
      }

      // apply name
      socket.on("name", function (data) {
        if (data.name != null) {
          const list = document.getElementById('name_list');
          const name = document.createElement('div');
          name.innerText = data.name;
          name.id = data.peerId + 'name';
          list.appendChild(name);
        }
      });

      socket.on("name4stream", function (data) {
        console.log('name4stream');
        if (data.name != null) {
          console.log(data.name);
          const video = document.getElementById(data.peerId);
          if (video != null) {
            const name = document.createElement('span');
            name.innerText = data.name;
            video.appendChild(name);
          }
        }
      });

      // functions ///////////////////////////////////////////////////

      // get browser information
      function get_browser(userAgent) {
        if (userAgent.indexOf('opera') != -1) {
          return 'opera';
        } else if (userAgent.indexOf('msie') != -1) {
          return 'ie';
        } else if (userAgent.indexOf('chrome') != -1) {
          return 'chrome';
        } else if (userAgent.indexOf('safari') != -1) {
          return 'safari';
        } else if (userAgent.indexOf('gecko') != -1) {
          return 'gecko';
        } else {
          return false;
        }
      }

      // listen event
      function set_event() {
        watchTrigger.addEventListener('click', watch, { once: true });
        async function watch() {
          localVideo.hidden = true;
          local_sign.hidden = true;
          await screenTrigger.removeEventListener('click', screen);
          await cameraTrigger.removeEventListener('click', camera);
          await watchTrigger.removeEventListener('click', watch);
          console.log('watch');
          is_shared = false;
          join_room("watch");
        };

        screenTrigger.addEventListener('click', screen, { once: true });
        async function screen() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          await screenTrigger.removeEventListener('click', screen);
          await cameraTrigger.removeEventListener('click', camera);
          await watchTrigger.removeEventListener('click', watch);
          is_shared = true;
          switch (browser) {
            case 'chrome':
              window.postMessage("share");
              break;
            default:
              get_user_media("", "local_video", "screen");
          }
          join_room("screen");
        };

        cameraTrigger.addEventListener('click', camera, { once: true });
        async function camera() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          await screenTrigger.removeEventListener('click', screen);
          await cameraTrigger.removeEventListener('click', camera);
          await watchTrigger.removeEventListener('click', watch);
          is_shared = true;
          get_user_media("", "local_video", "camera");
          join_room("camera");
        };
      }

      async function join_room(mode) {
        switch (mode) {
          case "screen":
          case "camera":
            var set_interval_id = setInterval(wait, 1000);
            async function wait() {
              console.log("wait");
              if (localStream != null) {
                console.log("break");
                clearInterval(set_interval_id);
                var room = await peer.joinRoom($("#rooms").val() + 0, {
                  mode: 'mesh',
                  stream: localStream
                });
                prepare4share(room);
                socket.emit("client_to_server_join", { room: $("#rooms").val() + 0, name: $("#name").val(), peerId: peer.id });
              }
            }
            break;
          case "watch":
            var room = await peer.joinRoom($("#rooms").val() + 0, {
              mode: 'mesh',
              stream: null
            });
            prepare4share(room);
            socket.emit("client_to_server_join", { room: $("#rooms").val() + 0, name: $("#name").val(), peerId: peer.id });
            break;
          default:
        }
      }

      // capture
      function get_user_media(streamId, videoId, mode) {
        switch (mode) {
          case 'screen':
            switch (browser) {
              case 'chrome':
                navigator.mediaDevices.getUserMedia({
                  video: {
                    mandatory: {
                      chromeMediaSource: 'desktop',
                      chromeMediaSourceId: streamId
                    }
                  },
                  audio: {
                    mandatory: {
                      chromeMediaSource: 'desktop',
                      chromeMediaSourceId: streamId
                    }
                  }
                }).then(stream => {
                  localStream = stream;
                  document.getElementById(videoId).srcObject = localStream;
                  let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
                  if (typeof deviceId === 'object') {
                    deviceId = JSON.stringify(deviceId);
                  }
                  console.log(`stream.getConstraints().deviceId=${deviceId}`);

                  // catch 'ended'
                  stream.getVideoTracks().forEach(track => {
                    track.addEventListener('ended', function () {
                      console.log("ended");
                      window.postMessage({ direction: "stream_event", message: "ended" }, "*");
                    }, { once: true });
                  });
                }).catch(async err => {
                  console.error(err);
                  switch (err.name) {
                    default:
                      localVideo.hidden = true;
                      local_sign.hidden = true;
                      await screenTrigger.removeEventListener('click', screen);
                      await cameraTrigger.removeEventListener('click', camera);
                      await watchTrigger.removeEventListener('click', watch);
                      is_shared = false;
                      const roomId = await $("#rooms").val() + 0;
                      var room = await peer.joinRoom(roomId, {
                        mode: 'mesh',
                        stream: null
                      });
                      prepare4share(room);
                      console.log('nyan');
                      break;
                  }
                });
                break;
              default:
                const is_screen = window.confirm('あなたが共有したいのはスクリーン全体ですか?');
                navigator.mediaDevices.getUserMedia({
                  video: { mediaSource: is_screen ? 'screen' : 'window' },
                  audio: { mediaSource: 'audioCapture'}
                }).then(stream => {
                  localStream = stream;
                  document.getElementById(videoId).srcObject = localStream;
                  let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
                  if (typeof deviceId === 'object') {
                    deviceId = JSON.stringify(deviceId);
                  }
                  console.log(`stream.getConstraints().deviceId=${deviceId}`);

                  // catch 'ended'
                  stream.getVideoTracks().forEach(track => {
                    track.addEventListener('ended', function () {
                      console.log("ended");
                      window.postMessage({ direction: "stream_event", message: "ended" }, "*");
                    }, { once: true });
                  });
                }).catch(async err => {
                  console.error(err);
                  switch (err.name) {
                    default:
                      localVideo.hidden = true;
                      local_sign.hidden = true;
                      await screenTrigger.removeEventListener('click', screen);
                      await cameraTrigger.removeEventListener('click', camera);
                      await watchTrigger.removeEventListener('click', watch);
                      is_shared = false;
                      const roomId = await $("#rooms").val() + 0;
                      var room = await peer.joinRoom(roomId, {
                        mode: 'mesh',
                        stream: null
                      });
                      prepare4share(room);
                      console.log('nyan');
                      break;
                  }
                });;
            }
            break;
          case 'camera':
            const is_mic = window.confirm('マイク入力を共有しますか?');
            navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: "environment"
              },
              audio: is_mic
            }).then(stream => {
              localStream = stream;
              document.getElementById(videoId).srcObject = localStream;
              let deviceId = stream.getVideoTracks()[0].getConstraints().deviceId;
              if (typeof deviceId === 'object') {
                deviceId = JSON.stringify(deviceId);
              }
              console.log(`stream.getConstraints().deviceId=${deviceId}`);

              // catch 'ended'
              stream.getVideoTracks().forEach(track => {
                track.addEventListener('ended', function () {
                  console.log("ended");
                  window.postMessage({ direction: "stream_event", message: "ended" }, "*");
                }, { once: true });
              });
            }).catch(async err => {
              console.error(err);
              switch (err.name) {
                default:
                  localVideo.hidden = true;
                  local_sign.hidden = true;
                  await screenTrigger.removeEventListener('click', screen);
                  await cameraTrigger.removeEventListener('click', camera);
                  await watchTrigger.removeEventListener('click', watch);
                  is_shared = false;
                  const roomId = await $("#rooms").val() + 0;
                  var room = await peer.joinRoom(roomId, {
                    mode: 'mesh',
                    stream: null
                  });
                  prepare4share(room);
                  console.log('nyan');
                  break;
              }
            });;
            break;
        }
      }

      // share
      async function prepare4share(room) {
        console.log('prepare');
        roomId_form.disabled = true;
        leaveTrigger.disabled = false;

        room.on('stream', stream => {
          console.log(stream.peerId);
          if (stream != null) {
            const newVideo = document.createElement('video');
            newVideo.setAttribute('id', stream.peerId + 'video');
            newVideo.autoplay = true;
            newVideo.controls = true;
            newVideo.srcObject = stream;
            // await newVideo.play().catch(console.error);
            const area = document.createElement('div');
            area.appendChild(newVideo);
            area.setAttribute('class', 'video_area');
            area.setAttribute('id', stream.peerId);
            remoteVideos.append(area);

            socket.emit("name_request4stream", { room: $("#rooms").val() + 0, peerId: stream.peerId });
          }
        });

        room.on('peerJoin', peerId => {
            socket.emit("name_request", { room: $("#rooms").val() + 0, peerId: peerId });
        });

        room.on('peerLeave', peerId => {
          console.log(peerId);
          console.log("remove");
          remoteVideo = document.getElementById(peerId + 'video');
          if (remoteVideo != null) {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.remove();
            Array.from(document.getElementById(peerId).getElementsByTagName('span')).forEach(sign => {
              console.log("remove_sign");
              sign.remove();
            });
          }

          var name_tag = document.getElementById(peerId + 'name');
          if (name_tag != null) name_tag.remove();
        });

        room.once('close', async () => {
          console.log("remove");
          await Array.from(remoteVideos.getElementsByTagName('video')).forEach(remoteVideo => {
            remoteVideo.srcObject.getTracks().forEach(track => track.stop());
            remoteVideo.remove();
          });
          Array.from(remoteVideos.getElementsByTagName('span')).forEach(sign => {
            sign.remove();
          });
          Array.from(nameList.getElementsByTagName('div')).forEach(name => {
            name.remove();
          });
          if (localStream != null) {
            await localStream.getTracks().forEach(function (track) {
              track.stop();
            });
          }
          await window.removeEventListener("message", listen_message);
          await screenTrigger.removeEventListener('click', change2screen);
          await cameraTrigger.removeEventListener('click', change2camera);
          await watchTrigger.removeEventListener('click', change2watch);
          roomId_form.disabled = false;
          leaveTrigger.disabled = true;
          socket.emit("client_to_server_exit", { room: $("#rooms").val() + 0, peerId: peer.id });
          set_event();
        });

        room.on('data', async ({ data, src }) => {
          console.log(data);
          var remoteVideo = document.getElementById(src);
          if (remoteVideo != null) {
            switch (data) {
              case "watch":
                remoteVideo.hidden = true;
                break;
              case "share":
                remoteVideo.hidden = false;
                break;
            }
          }
        });

        window.addEventListener("message", listen_message);
        async function listen_message(event) {
          switch (event.data.direction) {
            case 'streamId':
              await get_user_media(event.data.message, "local_video", "screen");
              var set_interval_id = setInterval(wait, 1000);
              function wait() {
                if (localStream != null) {
                  clearInterval(set_interval_id);
                  room.replaceStream(localStream);
                  room.send('share');
                  console.log("replace");
                }
              }
              break;
            case 'stream_event':
              switch (event.data.message) {
                case 'ended':
                  change2watch();
                  break;
              }
              break;
          }
        };

        screenTrigger.addEventListener('click', change2screen);
        async function change2screen() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          if (localStream != null) {
            await localStream.getTracks().forEach(function (track) {
              track.stop();
            });
            localStream = null;
          }
          switch (browser) {
            case 'chrome':
              window.postMessage("share");
              break;
            default:
              window.postMessage({ direction: "streamId", message: "" }, "*");
          }
          is_shared = true;
        };

        cameraTrigger.addEventListener('click', change2camera);
        async function change2camera() {
          localVideo.hidden = false;
          local_sign.hidden = false;
          if (localStream != null) {
            await localStream.getTracks().forEach(function (track) {
              track.stop();
            });
            localStream = null;
          }
          await get_user_media("", "local_video", 'camera');
          var set_interval_id = setInterval(wait, 1000);
          function wait() {
            if (localStream != null) {
              clearInterval(set_interval_id);
              room.replaceStream(localStream);
              room.send('share');
              console.log("replace");
            }
          }
          is_shared = true;
        };

        watchTrigger.addEventListener('click', change2watch);
        async function change2watch() {
          localVideo.hidden = true;
          local_sign.hidden = true;
          is_shared = false;
          if (localStream != null) {
            await localStream.getTracks().forEach(async function (track) {
              await track.stop();
              localStream.removeTrack(track);
            });
          }
          room.send("watch");
        };

        leaveTrigger.addEventListener('click', () => {
          console.log('close');
          localVideo.hidden = true;
          local_sign.hidden = true;
          room.close();
        }, { once: true });

        peer.on('error', console.error);
      }
    })();
  </script>
</body>
</html>
